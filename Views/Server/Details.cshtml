@model CveWebApp.Models.ServerDetailsViewModel
@{
    ViewData["Title"] = $"Server Details - {Model.Server.ServerName}";
}

<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-server"></i> @Model.Server.ServerName</h2>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back to Server List
            </a>
        </div>

        <!-- Server Information -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Server Name:</dt>
                            <dd class="col-sm-8">@Model.Server.ServerName</dd>

                            @if (!string.IsNullOrEmpty(Model.Server.Environment))
                            {
                                <dt class="col-sm-4">Environment:</dt>
                                <dd class="col-sm-8"><span class="badge bg-secondary">@Model.Server.Environment</span></dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.Project))
                            {
                                <dt class="col-sm-4">Project:</dt>
                                <dd class="col-sm-8">@Model.Server.Project</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.ServiceOwner))
                            {
                                <dt class="col-sm-4">Service Owner:</dt>
                                <dd class="col-sm-8">@Model.Server.ServiceOwner</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.IDEL))
                            {
                                <dt class="col-sm-4">IDEL:</dt>
                                <dd class="col-sm-8">@Model.Server.IDEL</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-network-wired"></i> Infrastructure</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            @if (!string.IsNullOrEmpty(Model.Server.VCenter))
                            {
                                <dt class="col-sm-4">VCenter:</dt>
                                <dd class="col-sm-8">@Model.Server.VCenter</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.Cluster))
                            {
                                <dt class="col-sm-4">Cluster:</dt>
                                <dd class="col-sm-8">@Model.Server.Cluster</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.ServerIP))
                            {
                                <dt class="col-sm-4">Server IP:</dt>
                                <dd class="col-sm-8"><code>@Model.Server.ServerIP</code></dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.ManagementIP))
                            {
                                <dt class="col-sm-4">Management IP:</dt>
                                <dd class="col-sm-8"><code>@Model.Server.ManagementIP</code></dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.MaintenanceWindows))
                            {
                                <dt class="col-sm-4">Maintenance:</dt>
                                <dd class="col-sm-8">@Model.Server.MaintenanceWindows</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Operating System Information -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-desktop"></i> Operating System</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            @if (!string.IsNullOrEmpty(Model.Server.OperatingSystem))
                            {
                                <dt class="col-sm-4">OS:</dt>
                                <dd class="col-sm-8">@Model.Server.OperatingSystem</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.OperatingSystemVersion))
                            {
                                <dt class="col-sm-4">Version:</dt>
                                <dd class="col-sm-8">@Model.Server.OperatingSystemVersion</dd>
                            }

                            @if (Model.Server.LastBootTime.HasValue)
                            {
                                <dt class="col-sm-4">Last Boot:</dt>
                                <dd class="col-sm-8">@Model.Server.LastBootTime.Value.ToString("yyyy-MM-dd HH:mm")</dd>
                            }

                            @if (!string.IsNullOrEmpty(Model.Server.LocalAdmins))
                            {
                                <dt class="col-sm-4">Local Admins:</dt>
                                <dd class="col-sm-8">@Model.Server.LocalAdmins</dd>
                            }
                        </dl>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-hdd"></i> Storage</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            @if (Model.Server.OSDiskSize.HasValue)
                            {
                                <dt class="col-sm-4">OS Disk Size:</dt>
                                <dd class="col-sm-8">@Model.Server.OSDiskSize.Value.ToString("F2") GB</dd>
                            }

                            @if (Model.Server.OSDiskFree.HasValue)
                            {
                                <dt class="col-sm-4">OS Disk Free:</dt>
                                <dd class="col-sm-8">
                                    @Model.Server.OSDiskFree.Value.ToString("F2") GB
                                    @if (Model.Server.OSDiskSize.HasValue)
                                    {
                                        var percentFree = (Model.Server.OSDiskFree.Value / Model.Server.OSDiskSize.Value) * 100;
                                        <span class="badge @(percentFree < 10 ? "bg-danger" : percentFree < 20 ? "bg-warning" : "bg-success")">
                                            @percentFree.ToString("F1")%
                                        </span>
                                    }
                                </dd>
                            }

                            <dt class="col-sm-4">Last Updated:</dt>
                            <dd class="col-sm-8">@Model.Server.LastUpdated.ToString("yyyy-MM-dd HH:mm")</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Services and CVE Compliance -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> Installed Services</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.InstalledServices.Any())
                        {
                            <div class="list-group">
                                @foreach (var service in Model.InstalledServices)
                                {
                                    <div class="list-group-item">
                                        <strong>@service.ServiceName</strong>
                                        @if (!string.IsNullOrEmpty(service.Description))
                                        {
                                            <br><small class="text-muted">@service.Description</small>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No services configured for this server.</p>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt"></i> Security Compliance</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-6">Total CVE Exposures:</dt>
                            <dd class="col-sm-6">@Model.ComplianceSummary.TotalCveExposures</dd>

                            <dt class="col-sm-6">Compliant:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-success">@Model.ComplianceSummary.CompliantCves</span>
                            </dd>

                            <dt class="col-sm-6">Non-Compliant:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-danger">@Model.ComplianceSummary.NonCompliantCves</span>
                            </dd>
                        </dl>

                        @if (Model.ComplianceSummary.NonCompliantCves > 0)
                        {
                            <hr>
                            <h6>Severity Breakdown:</h6>
                            <div class="row text-center">
                                @if (Model.ComplianceSummary.CriticalExposures > 0)
                                {
                                    <div class="col-3">
                                        <span class="badge bg-danger">@Model.ComplianceSummary.CriticalExposures</span>
                                        <small class="d-block">Critical</small>
                                    </div>
                                }
                                @if (Model.ComplianceSummary.HighExposures > 0)
                                {
                                    <div class="col-3">
                                        <span class="badge bg-warning">@Model.ComplianceSummary.HighExposures</span>
                                        <small class="d-block">High</small>
                                    </div>
                                }
                                @if (Model.ComplianceSummary.MediumExposures > 0)
                                {
                                    <div class="col-3">
                                        <span class="badge bg-info">@Model.ComplianceSummary.MediumExposures</span>
                                        <small class="d-block">Medium</small>
                                    </div>
                                }
                                @if (Model.ComplianceSummary.LowExposures > 0)
                                {
                                    <div class="col-3">
                                        <span class="badge bg-secondary">@Model.ComplianceSummary.LowExposures</span>
                                        <small class="d-block">Low</small>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Installed KBs -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Installed Knowledge Base Articles (@Model.InstalledKbs.Count())</h5>
                    </div>
                    <div class="card-body">
                        @if (Model.InstalledKbs.Any())
                        {
                            <div class="row">
                                @foreach (var kb in Model.InstalledKbs.OrderBy(k => k.KB))
                                {
                                    <div class="col-md-2 col-sm-3 col-6 mb-2">
                                        <span class="badge bg-primary">@kb.KB</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No KB installations recorded for this server.</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- CVE Exposures -->
        @if (Model.CveExposures.Any())
        {
            <div class="row mt-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-bug"></i> CVE Exposures (@Model.CveExposures.Count())</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>CVE ID</th>
                                            <th>Severity</th>
                                            <th>Product</th>
                                            <th>Required KBs</th>
                                            <th>Missing KBs</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var cve in Model.CveExposures.Take(20))
                                        {
                                            <tr>
                                                <td><code>@cve.CveId</code></td>
                                                <td>
                                                    <span class="badge @(cve.MaxSeverity?.ToLower() switch {
                                                        "critical" => "bg-danger",
                                                        "important" or "high" => "bg-warning",
                                                        "moderate" or "medium" => "bg-info",
                                                        "low" => "bg-secondary",
                                                        _ => "bg-light text-dark"
                                                    })">@cve.MaxSeverity</span>
                                                </td>
                                                <td>@cve.Product</td>
                                                <td>
                                                    @string.Join(", ", cve.RequiredKbs)
                                                </td>
                                                <td>
                                                    @if (cve.MissingKbs.Any())
                                                    {
                                                        <span class="text-danger">@string.Join(", ", cve.MissingKbs)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">None</span>
                                                    }
                                                </td>
                                                <td>
                                                    @if (cve.IsCompliant)
                                                    {
                                                        <span class="badge bg-success">Compliant</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">Exposed</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                            @if (Model.CveExposures.Count() > 20)
                            {
                                <p class="text-muted mt-2">
                                    Showing first 20 of @Model.CveExposures.Count() CVE exposures.
                                </p>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>